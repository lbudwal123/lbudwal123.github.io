<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="theme-color" content="#000000" />
  <meta name="description" content="Web site created using create-react-app" />

  <title>Amelia Chat</title>

</head>

<body>


  <div class="chat-overlay">
    <div class="chat-overlay-wrapper">
      <div class="chat-overlay-header-mobile">
        <img class="close" src="./close.png" alt="toggle chat overlay" />
      </div>
      <iframe id="receiver"
        src="https://porterair.dev.amelia.com/Amelia/ui/porterair_dev/?embed=iframe&domainCode=porterair"
        frameborder="0" width="100%" height="100%" allow="geolocation; microphone; camera">
        <p>Your browser does not support iframes.</p>
      </iframe>

      <button onclick='resetconversation()'>RESET CONVERSATION</button>
      <div class="chat-overlay-header">
        <img class="chat-overlay-header-img close" src="./close.png" alt="toggle chat overlay" />
        <img class="chat-overlay-header-img open" src="./icon.png" alt="toggle chat overlay" />
      </div>
    </div>
  </div>

</body>


<script>


//Function to process a payload send by Amelia, the Amelia url is tasken from the iframe source
function receiveMessage(e, data) {
  console.log("This is Receive message function")
    console.log(e);
    console.log(data);
   
    var iframeElem = document.getElementById('receiver');
    var ameliaurl = new URL(iframeElem.src);
    var baseurl = "https://"+ ameliaurl.hostname;;
    var ui_url = "https://" + ameliaurl.hostname + ameliaurl.pathname;
    console.log("AMELIA_OVERLAY::ReceivedMessage: " + e);

    // if (e.origin !== baseurl) {
    //     console.log('chatoverlay: Wrong domain!');
    //     return;
    // } else {
        if (e.data.actionType === "errorMessage") {
            console.log("AMELIA_OVERLAY::ReceivedMessage:CustomUI:", e.data.actionData.message);
        }
        if (e.data.action === "sendfunction") {
            console.log("AMELIA_OVERLAY::SendFunctionReceived:", e.data)
            var sFunction = e.data.function;
            console.log("AMELIA_OVERLAY::SendFunction:", sFunction);
            switch (sFunction) {
                case "resetconversation":
                    console.log("AMELIA_OVERLAY::ReceivedMessage:Reset Conversation");
                    resetconversation();
                    var iframe = document.getElementById('receiver');
                    iframe.src = iframe.src;
                    break;
                    case "endconversation":
                    console.log("AMELIA_OVERLAY::ReceivedMessage:End Conversation");
                    endconversation();
                    var iframe = document.getElementById('receiver');
                    iframe.src = iframe.src;
                    break;
                case "getParentUrl":
                    var url = window.location.href;
                    sendAttributes('{"parenturl": "' + url + '"}');
                    break;
                case "hideoverlay":
                    ChatOverlayAction('hide');
                    break;
                case "showoverlay":
                    ChatOverlayAction('show');
                    break;
                case "showmsg":
                    window.alert("Hello! This message was triggered from Amelia!!");
                    break;
                default:
                    console.log("Default, do nothing");
                    break;
            }
        }
        if (e.data.action === "goto_url") {
            //separate function to open url in new window
            var url = e.data.url;
            if (e.data.newwindow == 'true') {
                window.open(url, "", "top=200,height=600,width=800");
            } else {
                window.location.href = url;
            }
        }
    // }
}

//Function to send a payload to Amelia
function sendToAmelia(payload) {
    var iframeElem = document.getElementById('receiver');
    var ameliaurl = new URL(iframeElem.src);
    var url = ameliaurl.origin + ameliaurl.pathname
    var receiverElem = document.getElementById('receiver').contentWindow;
    console.log(payload);
    console.log(url);
    receiverElem.postMessage(payload, url);
}

//can be called to reset the conversation
function resetconversation() {
  console.log("reset conversation function")
    var myJSON = { 'actionType': 'resetConversation', 'actionData': 'true' };
    sendToAmelia(myJSON);
    var iframe = document.getElementById('receiver');
    iframe.src = iframe.src;
}

//listener to listen for Amelia Messages
window.addEventListener('message', receiveMessage);
</script>





<script>

  function openChatOverlay(receiverElem, imgElemOpen, imgElemClose) {
    document.getElementById('receiver').classList.add("open");
    document.getElementById('receiver').classList.remove("close");
    document.getElementsByClassName('chat-overlay')[0].classList.add("chat-overlay-open");
    document.getElementsByClassName('chat-overlay')[0].classList.remove("chat-overlay-closed");
    document.getElementsByClassName('chat-overlay-header-mobile')[0].classList.remove('close');
    imgElemClose.style.opacity = 1;
    imgElemOpen.style.opacity = 0;
    localStorage.setItem('chatOverlayOpen', true);
  }

  function closeChatOverlay(receiverElem, imgElemOpen, imgElemClose) {
    document.getElementById('receiver').classList.add("close");
    document.getElementById('receiver').classList.remove("open");
    document.getElementsByClassName('chat-overlay')[0].classList.add("chat-overlay-closed");
    document.getElementsByClassName('chat-overlay')[0].classList.remove("chat-overlay-open");
    document.getElementsByClassName('chat-overlay-header-mobile')[0].classList.add('close');
    imgElemOpen.style.opacity = 1;
    imgElemClose.style.opacity = 0;
    localStorage.setItem('chatOverlayOpen', false);
  }

  function toggleChatOverlay() {
    /**
     * Toggles opening and closing of the chatOverlay
     * @returns - no return
     */
    var chatOverlayHeaderImgElemOpen = document.getElementsByClassName('chat-overlay-header-img open')[0];
    var chatOverlayHeaderImgElemClose = document.getElementsByClassName('chat-overlay-header-img close')[0];
    var receiverElem = document.getElementById('receiver');
    if (receiverElem.classList.contains('close')) {
      openChatOverlay(receiverElem, chatOverlayHeaderImgElemOpen, chatOverlayHeaderImgElemClose);
    } else {
      closeChatOverlay(receiverElem, chatOverlayHeaderImgElemOpen, chatOverlayHeaderImgElemClose);
    }
  }

  var chatOverlayHeaderElem = document.getElementsByClassName('chat-overlay-header')[0];
  chatOverlayHeaderElem.addEventListener('click', toggleChatOverlay);
  var chatOverlayHeaderElemMobile = document.getElementsByClassName('chat-overlay-header-mobile')[0];
  chatOverlayHeaderElemMobile.addEventListener('click', toggleChatOverlay);

  if (typeof (Storage) !== "undefined") {
    var chatOverlayOpen = localStorage.getItem('chatOverlayOpen');
    var chatOverlayHeaderImgElemOpen = document.getElementsByClassName('chat-overlay-header-img open')[0];
    var chatOverlayHeaderImgElemClose = document.getElementsByClassName('chat-overlay-header-img close')[0];
    var receiverElem = document.getElementById('receiver');
    if (chatOverlayOpen && localStorage.getItem('chatOverlayOpen') !== "true") {
      closeChatOverlay(receiverElem, chatOverlayHeaderImgElemOpen, chatOverlayHeaderImgElemClose);
    } else {
      openChatOverlay(receiverElem, chatOverlayHeaderImgElemOpen, chatOverlayHeaderImgElemClose);
    }
  } else {
    // Sorry! No Web Storage support..
    console.log('No localStorage support')
  }

</script>

<style>
  .chat-overlay {
    position: fixed;
    width: 376px;
    height: 500px;
    bottom: 24px;
    right: 24px;
    z-index: 90;
  }

  .chat-overlay-open {
    height: 512px;
  }

  .chat-overlay-closed {
    height: 78px;

  }

  .chat-overlay-wrapper {
    width: 376px;
    height: 448px;
  }

  .chat-overlay-header-mobile {
    display: none;
  }

  .chat-overlay-header {
    position: relative;
    height: 56px;
    width: 56px;
    border: 1px solid black;
    background: #000;
    margin-left: auto;
    border-radius: 50%;
    box-shadow: 1rem 1rem 5rem rgba(0, 0, 0, 0.5);
  }

  #receiver {
    transition: opacity 1s ease-in-out;
    opacity: 1;
    background: rgba(0, 0, 0, 0.5);
    box-shadow: 1rem 1rem 5rem rgba(0, 0, 0, 0.5);
    border-radius: 0.5rem;
  }

  #receiver.close {
    height: 0;
    opacity: 0;
    overflow: hidden;
  }

  #receiver.open {
    height: 100%;
    opacity: 1;
    overflow: hidden;
  }

  .chat-overlay-header-img {
    position: absolute;
    max-width: 14px;
    max-height: 14px;
    transition: opacity 1s ease-in-out;
    opacity: 1;
    right: 0px;
    left: 0px;
    top: 0px;
    bottom: 0px;
    margin: auto;
  }

  .chat-overlay-header-img.open {
    opacity: 0;
  }

  .absolute-cart-box {
    display: none;
  }

  @media only screen and (max-width: 768px) {
    .chat-overlay {
      width: 100%;
      position: fixed;
      height: 100%;
    }

    .chat-overlay-header-mobile {
      display: flex;
      width: inherit;
      height: 9%;
      background: #4d5aff;
    }

    .chat-overlay-header-mobile img {
      height: 30%;
      padding: 1rem;
      margin-left: auto;
    }

    .chat-overlay-header-mobile.close {
      display: none;
    }

    #receiver {
      border-radius: 0;
    }

    #receiver.close {
      height: 0;
      opacity: 0;
      overflow: hidden;
    }

    #receiver.open {
      height: 91%;
      opacity: 1;
      overflow: hidden;
    }

    .chat-overlay-open {
      height: 100%;
      bottom: 0px;
      right: 0px;
    }

    .chat-overlay-closed {
      height: 70px;
      bottom: 24px;
      right: 24px;
    }

    .chat-overlay-wrapper {
      width: 100%;
      height: 100%;
    }
  }
</style>

</html>